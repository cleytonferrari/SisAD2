SET TERM #;
CREATE PROCEDURE ATUALIZA_FICHA(NFICHA INTEGER)
RETURNS
(
 CONFIRMADA DOUBLE PRECISION,
 NAO_CONFIRMADA DOUBLE PRECISION
)
AS

DECLARE VARIABLE TOT DOUBLE PRECISION;
DECLARE VARIABLE STA CHAR(1);
DECLARE VARIABLE SALDOITEM DECIMAL(10,2);
DECLARE VARIABLE SALDOINICIAL DECIMAL (10,2);
DECLARE VARIABLE VPROCESSO DECIMAL (10,2);
DECLARE VARIABLE VANULACAO DECIMAL (10,2);
DECLARE VARIABLE VSUPLEMENTACAO DECIMAL (10,2);
DECLARE VARIABLE SALDOTEMP DECIMAL (10,2);
BEGIN
 SELECT DOTACAOINICIAL FROM FICHA
 WHERE FICHA_ID = :NFICHA
 INTO
   :SALDOINICIAL;

FOR
 SELECT
   SALDOATUALDOTACAOINICIAL, VALORPROCESSO, VALORANULACAO, VALORSUPLEMENTACAO
 FROM
   ITENSFICHA WHERE FICHA_ID = :NFICHA ORDER BY DATA, NUMPROCESSO, NUMDECRETO
 INTO
   :SALDOITEM, :VPROCESSO, :VANULACAO, :VSUPLEMENTACAO
 DO BEGIN

    SALDOTEMP = :SALDOINICIAL - :VPROCESSO - :VANULACAO + :VSUPLEMENTACAO;
    UPDATE ITENSFICHA SET
      SALDOATUALDOTACAOINICIAL = :SALDOTEMP
    WHERE
      FICHA_ID = :NFICHA;
    SALDOINICIAL = :SALDOTEMP;
    
 END

SUSPEND;
END #;









COMMIT WORK;
SET AUTODDL OFF;
SET TERM ^ ;

/* Stored procedures */

CREATE PROCEDURE "ATUALIZA_FICHA" 
(
  "NFICHA" INTEGER
)
RETURNS
(
  "CONFIRMADA" DOUBLE PRECISION,
  "NAO_CONFIRMADA" DOUBLE PRECISION
)
AS
BEGIN EXIT; END ^


ALTER PROCEDURE "ATUALIZA_FICHA" 
(
  "NFICHA" INTEGER
)
RETURNS
(
  "CONFIRMADA" DOUBLE PRECISION,
  "NAO_CONFIRMADA" DOUBLE PRECISION
)
AS
DECLARE VARIABLE TOT DOUBLE PRECISION;
DECLARE VARIABLE STA CHAR(1);
DECLARE VARIABLE SALDOITEM DECIMAL(10,2);
DECLARE VARIABLE SALDOINICIAL DECIMAL (10,2);
DECLARE VARIABLE VPROCESSO DECIMAL (10,2);
DECLARE VARIABLE VANULACAO DECIMAL (10,2);
DECLARE VARIABLE VSUPLEMENTACAO DECIMAL (10,2);
DECLARE VARIABLE SALDOTEMP DECIMAL (10,2);
DECLARE VARIABLE itemid integer;
BEGIN
 SELECT DOTACAOINICIAL FROM FICHA
 WHERE FICHA_ID = :NFICHA
 INTO
   :SALDOINICIAL;
FOR
 SELECT
   ITENSFICHA_ID, SALDOATUALDOTACAOINICIAL, VALORPROCESSO, VALORANULACAO, VALORSUPLEMENTACAO
 FROM
   ITENSFICHA WHERE FICHA_ID = :NFICHA ORDER BY DATA, NUMPROCESSO, NUMDECRETO
 INTO
   :ITEMID, :SALDOITEM, :VPROCESSO, :VANULACAO, :VSUPLEMENTACAO
 DO BEGIN
    SALDOTEMP = :SALDOINICIAL - :VPROCESSO - :VANULACAO + :VSUPLEMENTACAO;
    UPDATE ITENSFICHA SET
      SALDOATUALDOTACAOINICIAL = :SALDOTEMP
    WHERE
      FICHA_ID = :NFICHA AND ITENSFICHA_ID = :ITEMID;
    SALDOINICIAL = :SALDOTEMP;
 END
SUSPEND;
END
 ^

SET TERM ; ^
COMMIT WORK;
SET AUTODDL ON;