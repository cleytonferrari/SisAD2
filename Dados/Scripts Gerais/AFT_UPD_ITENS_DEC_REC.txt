SET TERM #;
CREATE TRIGGER AFT_UPD_ITENS_DEC_REC FOR ITENS_DEC_RECURSO
ACTIVE AFTER UPDATE POSITION 0
AS
DECLARE VARIABLE TUPLAS SMALLINT;
DECLARE VARIABLE NVALOR DECIMAL(10,2);
DECLARE VARIABLE NFICHA INTEGER;
DECLARE VARIABLE NDATA DATE;
DECLARE VARIABLE NAN_EX VARCHAR(2);
DECLARE VARIABLE NDECRETO VARCHAR(9);
BEGIN
 SELECT FICHA, VALOR FROM ITENS_DEC_RECURSO
 WHERE
   ITENS_DEC_RECURSO_ID = NEW.ITENS_DEC_RECURSO_ID
 INTO :NFICHA, :NVALOR;

 SELECT DECRETO_ID, DATA, AN_EX FROM DECRETO
 WHERE
   DECRETO_ID = NEW.DECRETO_ID
 INTO :NDECRETO, :NDATA, :NAN_EX;

 IF (:NAN_EX = 'AN') THEN BEGIN
   UPDATE ITENSFICHA SET
   FICHA_ID = :NFICHA,
   VALORANULACAO = :NVALOR,
   VALORSUPLEMENTACAO = 0,
   VALORPROCESSO = 0,
   DATA = :NDATA,
   NUMDECRETO = :NDECRETO
   WHERE
     NUMDECRETO = :NDECRETO AND FICHA_ID = NEW.FICHA;

 END

END #;