SET TERM #;
CREATE TRIGGER "AFT_UPD_ANULACAOAD" FOR "ANULACAOAD"
ACTIVE AFTER UPDATE POSITION 0
AS
DECLARE VARIABLE NAD INTEGER;
DECLARE VARIABLE VALORAD DECIMAL(10,2);
DECLARE VARIABLE NFICHA_ID INTEGER;
BEGIN
  SELECT AD_ID, FICHA_ID FROM AD WHERE AD_ID = NEW.AD_ID
  INTO :NAD, :NFICHA_ID;

  IF (NEW.PARCIALTOTAL = 'TOTAL') THEN BEGIN
    SELECT VALORTOTAL FROM AD WHERE AD_ID = NEW.AD_ID
    INTO :VALORAD;
  END
  
  IF (NEW.PARCIALTOTAL = 'PARCIAL') THEN BEGIN
    VALORAD = NEW.VALORPARCIAL;
  END

  UPDATE ITENSFICHA SET
  FICHA_ID = :NFICHA_ID,
  VALORANULACAO = 0,
  VALORSUPLEMENTACAO = :VALORAD,
  VALORPROCESSO = 0,
  DATA = NEW.DATA,
  NUMANULACAO = NEW.ANULACAOAD_ID
  WHERE
   NUMANULACAO = NEW.ANULACAOAD_ID;

END #;
