SET TERM #;
CREATE TRIGGER "AFT_UPD_AD" FOR "AD"
ACTIVE AFTER UPDATE POSITION 0
AS
DECLARE VARIABLE TUPLAS SMALLINT;
DECLARE VARIABLE NNUMEROAD VARCHAR(8);
DECLARE VARIABLE NVALORTOTAL DECIMAL (10,2);
DECLARE VARIABLE NFICHA_ID INTEGER;
DECLARE VARIABLE NDATA DATE;
DECLARE VARIABLE NNUMEROPROCESSO VARCHAR(10);

BEGIN
  IF (OLD.FICHA_ID <> NEW.FICHA_ID) THEN
  BEGIN
  SELECT COUNT(*)
    FROM
      FICHA
    WHERE
      FICHA_ID = NEW.FICHA_ID
    INTO :TUPLAS;
    IF (:TUPLAS = 0 ) THEN
    BEGIN
      EXCEPTION EXP_UPD_RESTRICT;
    END
  END
  IF (OLD.SECRETARIASMUNICIPAIS_ID <> NEW.SECRETARIASMUNICIPAIS_ID) THEN
  BEGIN
  SELECT COUNT(*)
    FROM
      SECRETARIASMUNICIPAIS
    WHERE
      SECRETARIASMUNICIPAIS_ID = NEW.SECRETARIASMUNICIPAIS_ID
    INTO :TUPLAS;
    IF (:TUPLAS = 0 ) THEN
    BEGIN
      EXCEPTION EXP_UPD_RESTRICT;
    END
  END
  IF (OLD.ITENSFICHA_ID <> NEW.ITENSFICHA_ID) THEN
  BEGIN
  SELECT COUNT(*)
    FROM
      ITENSFICHA
    WHERE
      ITENSFICHA_ID = OLD.ITENSFICHA_ID
    INTO :TUPLAS;
    IF (:TUPLAS > 0 ) THEN
    BEGIN
      UPDATE ITENSFICHA SET
      ITENSFICHA_ID = NEW.ITENSFICHA_ID
      WHERE
      ITENSFICHA_ID = OLD.ITENSFICHA_ID;
    END
  END
  IF (OLD.AD_ID <> NEW.AD_ID) THEN
  BEGIN
  SELECT COUNT(*)
    FROM
      ITENSAD
    WHERE
      AD_ID = OLD.AD_ID
    INTO :TUPLAS;
    IF (:TUPLAS > 0 ) THEN
    BEGIN
      UPDATE ITENSAD SET
      AD_ID = NEW.AD_ID
      WHERE
      AD_ID = OLD.AD_ID;
    END
  END

    SELECT NUMEROAD, VALORTOTAL, FICHA_ID, DATA, NUMEROPROCESSO FROM AD
    WHERE
      AD_ID = NEW.AD_ID
    INTO :NNUMEROAD, :NVALORTOTAL, :NFICHA_ID, :NDATA, :NNUMEROPROCESSO;

   UPDATE ITENSFICHA SET
   FICHA_ID = :NFICHA_ID,
   VALORANULACAO = 0,
   VALORSUPLEMENTACAO = 0,
   VALORPROCESSO = :NVALORTOTAL,
   DATA = :NDATA,
   NUMEROAD = :NNUMEROAD
   WHERE
     ITENSFICHA_ID = NEW.ITENSFICHA_ID;
  
END #;