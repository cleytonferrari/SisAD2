SET TERM #;
CREATE TRIGGER "AFT_INS_ANULACAOAD" FOR "ANULACAOAD"
ACTIVE AFTER INSERT POSITION 0
AS
DECLARE VARIABLE NAD INTEGER;
DECLARE VARIABLE VALORAD DECIMAL(10,2);
DECLARE VARIABLE NITEM INTEGER;
DECLARE VARIABLE NFICHA_ID INTEGER;
BEGIN
  SELECT AD_ID, FICHA_ID FROM AD WHERE AD_ID = NEW.AD_ID
  INTO :NAD, :NFICHA_ID;

  IF (NEW.PARCIALTOTAL = 'TOTAL') THEN BEGIN
    SELECT VALORTOTAL FROM AD WHERE AD_ID = NEW.AD_ID
    INTO :VALORAD;
  END
  
  IF (NEW.PARCIALTOTAL = 'PARCIAL') THEN BEGIN
    VALORAD = NEW.VALORPARCIAL;
  END

  SELECT MAX(ITENSFICHA_ID) FROM ITENSFICHA INTO :NITEM;

   INSERT INTO ITENSFICHA(ITENSFICHA_ID, FICHA_ID, VALORANULACAO, VALORSUPLEMENTACAO, VALORPROCESSO, DATA, NUMANULACAO)
   VALUES ((:NITEM+1), :NFICHA_ID, 0, :VALORAD, 0, NEW.DATA, NEW.ANULACAOAD_ID);

   UPDATE ANULACAOAD SET ITENSFICHA_ID = (:NITEM+1)
   WHERE
     ANULACAOAD_ID = NEW.ANULACAOAD_ID;

END #;
