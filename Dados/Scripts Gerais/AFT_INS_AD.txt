SET TERM #;
CREATE TRIGGER "AFT_INS_AD" FOR "AD"
ACTIVE AFTER INSERT POSITION 0
AS
DECLARE VARIABLE TUPLAS SMALLINT;
DECLARE VARIABLE NNUMEROAD VARCHAR(8);
DECLARE VARIABLE NVALORTOTAL DECIMAL (10,2);
DECLARE VARIABLE NFICHA_ID INTEGER;
DECLARE VARIABLE NDATA DATE;
DECLARE VARIABLE NNUMEROPROCESSO VARCHAR(10);
DECLARE VARIABLE NITENSFICHA_ID INTEGER;
BEGIN
  SELECT COUNT(*)
    FROM
      SECRETARIASMUNICIPAIS
    WHERE
      SECRETARIASMUNICIPAIS_ID = NEW.SECRETARIASMUNICIPAIS_ID
    INTO :TUPLAS;
    IF (:TUPLAS = 0 ) THEN
    BEGIN
      EXCEPTION EXP_INS_RESTRICT;
    END
  SELECT COUNT(*)
    FROM
      FICHA
    WHERE
      FICHA_ID = NEW.FICHA_ID
    INTO :TUPLAS;
    IF (:TUPLAS = 0 ) THEN
    BEGIN
      EXCEPTION EXP_INS_RESTRICT;
    END
    
    SELECT NUMEROAD, VALORTOTAL, FICHA_ID, DATA, NUMEROPROCESSO FROM AD
    WHERE
      AD_ID = NEW.AD_ID
    INTO :NNUMEROAD, :NVALORTOTAL, :NFICHA_ID, :NDATA, :NNUMEROPROCESSO;

    SELECT MAX(ITENSFICHA_ID) FROM ITENSFICHA
    INTO :NITENSFICHA_ID;
    
   INSERT INTO ITENSFICHA(ITENSFICHA_ID, FICHA_ID, VALORANULACAO, VALORSUPLEMENTACAO, VALORPROCESSO, DATA, NUMEROAD)
   VALUES ((:NITENSFICHA_ID+1), :NFICHA_ID, 0, 0, :NVALORTOTAL, :NDATA, :NNUMEROAD);
    
   UPDATE AD SET ITENSFICHA_ID = (:NITENSFICHA_ID+1)
   WHERE
     AD_ID = NEW.AD_ID;
    
    
END #;